<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Details</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Market Details</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="admin.html">Admin</a>
      <a href="login.html" id="login-link">Login / Register</a>
      <span id="user-greeting" class="hidden"></span>
    </nav>
  </header>

  <main>
    <section id="market-container">
      <!-- Market details injected here -->
    </section>

    <!-- Countdown Timer -->
    <section id="countdown-section" class="hidden">
      <h3>Time Remaining:</h3>
      <p id="countdown-timer" class="countdown"></p>
      <div id="timezones" class="tz-display"></div>
    </section>

    <!-- Line Chart Section -->
    <section id="chart-section" class="hidden">
      <h3>Price History</h3>
      <canvas id="priceChart" width="400" height="200"></canvas>
    </section>

    <!-- Bet Section -->
    <section id="bet-container" class="hidden">
      <h2>Place a Bet</h2>
      <div id="bet-message"></div>
      <form id="bet-form">
        <label>
          Amount (shares):
          <input type="number" id="bet-amount" name="amount" step="0.01" min="0.01" required>
        </label>
        <div>
          <label><input type="radio" name="side" value="YES" checked> YES</label>
          <label><input type="radio" name="side" value="NO"> NO</label>
        </div>
        <button type="submit">Place Bet</button>
      </form>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      updateUserGreeting();
      const market = await loadMarketDetails();
      console.log("Loaded market:", market);
      console.log("Expires_at:", market?.expires_at);


      // Countdown setup
      if (market && market.expires_at) {
        const countdownSection = document.getElementById('countdown-section');
        countdownSection.classList.remove('hidden');
        const endTime = new Date(market.expires_at);
        const timerEl = document.getElementById('countdown-timer');
        const tzEl = document.getElementById('timezones');

        const updateTimer = () => {
          const diff = endTime - new Date();
          if (diff <= 0) {
            timerEl.textContent = "Market closed";
            clearInterval(timer);
            return;
          }
          const hrs = Math.floor(diff / 1000 / 60 / 60);
          const mins = Math.floor((diff / 1000 / 60) % 60);
          const secs = Math.floor((diff / 1000) % 60);
          timerEl.textContent = `${hrs}h ${mins}m ${secs}s`;
        };
        updateTimer();
        const timer = setInterval(updateTimer, 1000);

         // 🌍 Show absolute expiration times in multiple zones
        const timeOptions = { dateStyle: 'full', timeStyle: 'long' };
        const timeStrings = [
          { label: 'New York (EST)', tz: 'America/New_York' },
          { label: 'London (GMT)', tz: 'Europe/London' },
          { label: 'Beijing (UTC+8)', tz: 'Asia/Shanghai' },
          { label: 'Tokyo (JST)', tz: 'Asia/Tokyo' },
        ].map(t =>
          `<p><strong>${t.label}:</strong> ${endTime.toLocaleString('en-US', { ...timeOptions, timeZone: t.tz })}</p>`
        ).join('');

        tzEl.innerHTML = timeStrings;
      }



      // Real price chart from backend /markets/{id}/history
      if (market) {
        const chartSection = document.getElementById('chart-section');
        chartSection.classList.remove('hidden');
        const ctx = document.getElementById('priceChart').getContext('2d');

        try {
          const resp = await fetch(`${apiBase}/markets/${market.id}/history`);
          const history = await resp.json();

          if (!Array.isArray(history) || history.length === 0) {
            console.warn("No price history yet for this market.");
            ctx.font = "16px sans-serif";
            ctx.fillText("No price history yet — place a bet to start tracking!", 10, 50);
            return;
          }

          const labels = history.map(p => new Date(p.timestamp).toLocaleString());
          const yesPrices = history.map(p => p.price_yes);
          const noPrices = history.map(p => p.price_no);

          new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                { label: 'YES Price', data: yesPrices, borderColor: 'green', tension: 0.3, fill: false },
                { label: 'NO Price', data: noPrices, borderColor: 'red', tension: 0.3, fill: false }
              ]
            },
            options: {
              responsive: true,
              scales: {
                y: { min: 0, max: 1, title: { display: true, text: 'Price (0–1)' } },
                x: { title: { display: true, text: 'Timestamp' }, ticks: { maxRotation: 45, minRotation: 45 } }
              }
            }
          });
        } catch (err) {
          console.error("Failed to load price history:", err);
        }
      }
    });
  </script>
</body>
</html>
