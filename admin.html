<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Admin Panel</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="admin.html">Admin</a>
      <a href="login.html" id="login-link">Login / Register</a>
      <a href="portal.html" id="portal-link" class="hidden">My Portal</a>
      <a href="#" id="logout-link" class="hidden">Logout</a>
      <span id="user-greeting" class="hidden"></span>
    </nav>
  </header>

  <main>
    <!-- ‚úÖ Create Market -->
    <section>
      <h2>Create Market</h2>
      <div id="market-create-message"></div>
      <form id="create-market-form">
        <label>
          Title:
          <input type="text" id="market-title" required>
        </label>
        <label>
          Description:
          <textarea id="market-description" rows="3"></textarea>
        </label>
        <label>
          Liquidity (b):
          <input type="number" id="market-liquidity" min="1" step="1" value="100">
        </label>
        <label>
          Expires At (optional):
          <input type="datetime-local" id="market-expires">
        </label>
        <label>
          Admin Username:
          <input type="text" id="admin-username" required>
        </label>
        <label>
          Admin Password:
          <input type="password" id="admin-password" required>
        </label>
        <button type="submit">Create Market</button>
      </form>
    </section>

    <!-- ‚úÖ Delete Market -->
    <section>
      <h2>Delete Market</h2>
      <div id="market-delete-message"></div>
      <form id="delete-market-form">
        <label>
          Market ID:
          <input type="number" id="delete-market-id" required>
        </label>
        <label>
          Admin Username:
          <input type="text" id="delete-admin-username" required>
        </label>
        <label>
          Admin Password:
          <input type="password" id="delete-admin-password" required>
        </label>
        <button type="submit">Delete Market</button>
      </form>
    </section>

    <!-- ‚úÖ Market List -->
    <section>
      <h2>All Active Markets</h2>
      <div id="markets-message"></div>
      <table id="markets-table" class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Expires</th>
            <th>Resolved</th>
            <th>Outcome</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="refresh-markets">üîÑ Refresh List</button>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      updateUserGreeting();
      loadMarketsAdmin();

      // CREATE MARKET
      const createForm = document.getElementById('create-market-form');
      createForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const title = document.getElementById('market-title').value;
        const description = document.getElementById('market-description').value;
        const liquidity = parseFloat(document.getElementById('market-liquidity').value);
        const expires_at_input = document.getElementById('market-expires').value;
        const admin_username = document.getElementById('admin-username').value;
        const admin_password = document.getElementById('admin-password').value;
        const expires_at = expires_at_input ? new Date(expires_at_input).toISOString() : null;

        try {
          const res = await fetch(apiBase + '/markets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, liquidity, admin_username, admin_password, expires_at })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'Error creating market');
          document.getElementById('market-create-message').textContent = `‚úÖ Market created with ID ${data.id}`;
          createForm.reset();
          loadMarketsAdmin();
        } catch (err) {
          document.getElementById('market-create-message').textContent = err.message;
        }
      });

      // DELETE MARKET
      const deleteForm = document.getElementById('delete-market-form');
      deleteForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = document.getElementById('delete-market-id').value;
        const username = document.getElementById('delete-admin-username').value;
        const password = document.getElementById('delete-admin-password').value;
        await deleteMarketAdmin(id, username, password);
        loadMarketsAdmin();
      });

      // REFRESH LIST
      document.getElementById('refresh-markets').addEventListener('click', loadMarketsAdmin);
    });

    // LOAD MARKETS
    async function loadMarketsAdmin() {
      const tableBody = document.querySelector('#markets-table tbody');
      tableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
      try {
        const res = await fetch(apiBase + '/markets');
        const markets = await res.json();
        if (!res.ok) throw new Error('Failed to load markets.');
        if (markets.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6">No markets found.</td></tr>';
          return;
        }

        tableBody.innerHTML = '';
        markets.forEach(m => {
          const expires = m.expires_at ? new Date(m.expires_at).toLocaleString() : '‚Äî';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${m.id}</td>
            <td>${m.title}</td>
            <td>${expires}</td>
            <td>${m.resolved ? '‚úÖ' : '‚ùå'}</td>
            <td>${m.outcome || '‚Äî'}</td>
            <td>
              <button class="delete-btn" data-id="${m.id}">Delete</button>
              ${!m.resolved ? `<button class="resolve-btn" data-id="${m.id}">Resolve</button>` : ''}
            </td>
          `;
          tableBody.appendChild(tr);
        });

        // Delete handler
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            const id = e.target.getAttribute('data-id');
            const username = prompt('Enter admin username:');
            const password = prompt('Enter admin password:');
            if (username && password) {
              await deleteMarketAdmin(id, username, password);
              loadMarketsAdmin();
            }
          });
        });

        // Resolve handler (with admin prompt)
        document.querySelectorAll('.resolve-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            const id = e.target.getAttribute('data-id');
            const username = prompt('Enter admin username:');
            const password = prompt('Enter admin password:');
            const outcome = prompt("Enter outcome (YES or NO):");
            if (!username || !password || !["YES", "NO"].includes(outcome?.toUpperCase())) {
              alert("Invalid input or missing credentials.");
              return;
            }
            await resolveMarketAdmin(id, outcome.toUpperCase(), username, password);
            loadMarketsAdmin();
          });
        });

      } catch (err) {
        document.getElementById('markets-message').textContent = err.message;
      }
    }

    // DELETE
    async function deleteMarketAdmin(id, username, password) {
      const msg = document.getElementById('market-delete-message');
      try {
        const url = `${apiBase}/markets/${id}?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
        const res = await fetch(url, { method: 'DELETE' });
        const data = await res.json();
        msg.textContent = res.ok ? (data.detail || `‚úÖ Market ${id} deleted`) : (data.detail || 'Error deleting market');
      } catch {
        msg.textContent = 'Request failed.';
      }
    }

    // RESOLVE (with admin credentials)
    async function resolveMarketAdmin(marketId, outcome, username, password) {
      try {
        const body = JSON.stringify({ market_id: parseInt(marketId), outcome });
        const res = await fetch(apiBase + '/resolve', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa(username + ':' + password) // optional, for clarity
          },
          body
        });
        const data = await res.json();
        if (res.ok) {
          alert(`‚úÖ Market ${marketId} resolved as ${outcome}`);
        } else {
          alert(data.detail || 'Error resolving market');
        }
      } catch {
        alert('Request failed while resolving market.');
      }
    }
  </script>

  <style>
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    .admin-table th, .admin-table td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    .admin-table th {
      background-color: #f3f3f3;
    }
    .delete-btn, .resolve-btn {
      margin-right: 5px;
      border: none;
      padding: 5px 10px;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-btn {
      background-color: #e74c3c;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }
    .resolve-btn {
      background-color: #3498db;
    }
    .resolve-btn:hover {
      background-color: #2c80b4;
    }
  </style>
</body>
</html>
