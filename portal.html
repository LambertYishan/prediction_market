<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>User Portal</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <header>
    <h1>Your Portal</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="admin.html">Admin</a>
      <a href="portal.html">My Portal</a>
      <a href="#" id="logout-link">Logout</a>
      <span id="user-greeting" style="margin-left:10px; font-weight:bold;"></span>
    </nav>
  </header>

  <main>
    <!-- Profile -->
    <section id="profile-section">
      <h2>Profile Info</h2>
      <p id="user-info"></p>
      <button id="change-pass-btn">Change Password</button>
      <button id="claim-bonus-btn">Claim Daily Return</button>
      <p id="bonus-message"></p>
    </section>

    <!-- Membership Stats -->
    <section id="membership-stats">
      <h2>Membership Stats</h2>
      <p id="days-member"></p>
      <p id="days-since-login"></p>
    </section>

    <!-- Transaction History -->
    <section id="transaction-history">
      <h2>Transaction History</h2>
      <table id="transaction-table" class="styled-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Market</th>
            <th>Side / Outcome</th>
            <th>Shares</th>
            <th>Total ($)</th>
            <th>Avg Price</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="transaction-body"></tbody>
      </table>
    </section>

    <!-- Position / History Table -->
    <section id="history-section">
      <h2>Position History</h2>
      <table id="positionHistory-table" class="styled-table">
        <thead>
          <tr>
            <th>Market</th>
            <th>Side</th>
            <th>Amount</th>
            <th>Price</th>
            <th>Spent ($)</th>
            <th>Outcome</th>
            <th>PnL ($)</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="positionHistory-body"></tbody>
      </table>
      <p id="lifetime-pnl" style="margin-top:10px; font-weight:bold;"></p>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await updateUserGreeting();
      const userId = localStorage.getItem('user_id');
      if (!userId) {
        window.location.href = 'login.html';
        return;
      }

      // Load user info
      const userRes = await fetch(`${apiBase}/user/${userId}`);
      const user = await userRes.json();
      document.getElementById('user-info').textContent = `Username: ${user.username}`;

      // Load user bets
      const betsRes = await fetch(`${apiBase}/user/${userId}/bets`);
      const data = await betsRes.json();
      const tbody = document.getElementById('positionHistory-body');

      if (!data.bets || data.bets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">No positions yet.</td></tr>';
      } else {
        tbody.innerHTML = data.bets.map(b => `
          <tr>
            <td>${b.market_title}</td>
            <td>${b.side}</td>
            <td>${b.amount.toFixed(2)}</td>
            <td>${b.price.toFixed(2)}</td>
            <td>${b.total_cost.toFixed(2)}</td>
            <td>${b.outcome || '-'}</td>
            <td>${b.pnl.toFixed(2)}</td>
            <td>${new Date(b.timestamp).toLocaleString()}</td>
          </tr>
        `).join('');
      }

      // --- Membership Stats ---
      try {
        // Fetch membership stats (if your backend implements /user/{id}/stats)
        const statsRes = await fetch(`${apiBase}/user/${userId}/stats`);
        if (statsRes.ok) {
          const stats = await statsRes.json();
          const created = new Date(stats.created_at || user.created_at || Date.now());
          const lastLogin = new Date(stats.last_login || user.last_login || Date.now());
          const now = new Date();

          const daysMember = Math.floor((now - created) / (1000 * 60 * 60 * 24));
          const daysSinceLogin = Math.floor((now - lastLogin) / (1000 * 60 * 60 * 24));

          document.getElementById("days-member").textContent =
            `üë§ Member for ${daysMember} day${daysMember !== 1 ? "s" : ""}`;
          document.getElementById("days-since-login").textContent =
            `‚è±Ô∏è Last login ${daysSinceLogin} day${daysSinceLogin !== 1 ? "s" : ""} ago`;
        } else {
          document.getElementById("days-member").textContent = "Member stats unavailable.";
        }
      } catch (err) {
        console.warn("Could not load membership stats:", err);
      }

      // --- Transaction History ---
      try {
        const txRes = await fetch(`${apiBase}/user/${userId}/transactions`);
        const txData = await txRes.json();
        const txBody = document.getElementById("transaction-body");

        if (!txData.transactions || txData.transactions.length === 0) {
          txBody.innerHTML = "<tr><td colspan='7'>No transactions yet.</td></tr>";
        } else {
          txBody.innerHTML = txData.transactions.map(t => {
            const side = t.side_or_outcome || "-";
            const shares = t.shares ? t.shares.toFixed(2) : "-";
            const total = t.total || 0;
            const avg = t.avg_price ? t.avg_price.toFixed(3) : "-";
            return `
        <tr>
          <td>${t.type.replace(/_/g, " ")}</td>
          <td>${t.market_title || "-"}</td>
          <td>${side}</td>
          <td>${shares}</td>
          <td>${total.toFixed(2)}</td>
          <td>${avg}</td>
          <td>${new Date(t.timestamp).toLocaleString()}</td>
        </tr>`;
          }).join("");
        }
      } catch (err) {
        console.error("Error loading transactions:", err);
      }


      document.getElementById('lifetime-pnl').textContent =
        `Lifetime PnL: $${data.lifetime_pnl.toFixed(2)}`;

      // Change password
      document.getElementById('change-pass-btn').addEventListener('click', async () => {
        const oldPass = prompt("Enter old password:");
        const newPass = prompt("Enter new password:");
        if (!oldPass || !newPass) return;

        const res = await fetch(`${apiBase}/user/change_password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: parseInt(userId),
            old_password: oldPass,
            new_password: newPass
          })
        });
        const result = await res.json();
        alert(result.detail || "Password updated successfully!");
      });

      // Claim bonus
      document.getElementById('claim-bonus-btn').addEventListener('click', async () => {
        const msg = document.getElementById('bonus-message');
        msg.textContent = 'Processing...';
        try {
          const res = await fetch(`${apiBase}/user/${userId}/claim_bonus`, { method: 'POST' });
          const result = await res.json();
          if (res.ok) {
            msg.textContent = result.message || "‚úÖ Daily bonus claimed!";
            updateUserGreeting();
          } else {
            msg.textContent = result.detail || "‚ö†Ô∏è Unable to claim bonus.";
          }
        } catch {
          msg.textContent = "Network error, please try again.";
        }
      });
    });
  </script>
</body>

</html>