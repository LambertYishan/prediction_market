<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Prediction Market</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* --- optional quick styling for cards if not yet in styles.css --- */
    .section-title {
      margin-top: 30px;
      margin-bottom: 10px;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }

    .market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .market-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .market-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .market-card h3 {
      margin: 0 0 8px 0;
      font-size: 1.1em;
    }

    .market-card p {
      margin: 4px 0;
    }

    .btn {
      display: inline-block;
      margin-top: 6px;
      padding: 6px 10px;
      background-color: #1976d2;
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }

    .btn:hover {
      background-color: #0d47a1;
    }
  </style>
</head>

<body>
  <header>
    <h1>Prediction Market</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="admin.html">Admin</a>
      <a href="login.html" id="login-link">Login / Register</a>
      <a href="portal.html" id="portal-link" class="hidden">My Portal</a>
      <a href="#" id="logout-link" class="hidden">Logout</a>
      <span id="user-greeting" class="hidden"></span>
    </nav>
  </header>

  <main>
    <section>
      <h2 class="section-title">üü¢ Active Markets</h2>
      <div id="active-markets" class="market-grid"></div>
    </section>

    <section>
      <h2 class="section-title">‚ö´ Inactive Markets (Last 30 Days)</h2>
      <div id="inactive-markets" class="market-grid"></div>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      await updateUserGreeting();

      try {
        const res = await fetch(`${apiBase}/markets`);
        if (!res.ok) throw new Error("Failed to load markets");
        const markets = await res.json();

        const activeContainer = document.getElementById("active-markets");
        const inactiveContainer = document.getElementById("inactive-markets");

        activeContainer.innerHTML = "";
        inactiveContainer.innerHTML = "";

        if (!markets || markets.length === 0) {
          activeContainer.innerHTML = "<p>No markets available yet.</p>";
          return;
        }

        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

        for (const m of markets) {
          const expiry = m.expires_at ? new Date(m.expires_at) : null;
          const resolved = m.resolved === true;
          const deleted = m.status === "deleted"; // optional if you track this
          const isActive = expiry && expiry > now && !resolved && !deleted;

          // inactive if resolved, deleted, or expired within last 30 days
          const isRecentlyInactive =
            (!isActive) && (
              resolved ||
              deleted ||
              (expiry && expiry <= now && expiry >= thirtyDaysAgo)
            );

          if (!isActive && !isRecentlyInactive) continue; // skip older markets

          // calculate time remaining / since expiry
          let timeText = "";
          if (expiry) {
            const diffMs = expiry - now;
            const diffHours = Math.abs(diffMs) / (1000 * 60 * 60);
            if (isActive) {
              if (diffHours < 1) timeText = `${Math.round(diffHours * 60)} min left`;
              else timeText = `${diffHours.toFixed(1)} h left`;
            } else {
              timeText = `${Math.round(diffHours)} h ago`;
            }
          }

          const card = document.createElement("div");
          card.classList.add("market-card");
          card.innerHTML = `
        <h3>${m.title}</h3>
        <p><strong>Status:</strong>
          ${isActive ? "üü¢ Active"
              : resolved ? "‚úÖ Resolved"
                : deleted ? "‚ùå Deleted"
                  : "‚ö´ Expired"}</p>
        <p><strong>YES:</strong> ${(m.price_yes * 100).toFixed(1)}% | 
           <strong>NO:</strong> ${(m.price_no * 100).toFixed(1)}%</p>
        ${expiry ? `<p><strong>Expires (NY time):</strong> ${expiry.toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    dateStyle: 'medium',
                    timeStyle: 'short'
                  })}</p>` : ""}
        ${timeText ? `<p><em>${timeText}</em></p>` : ""}
        <a href="market.html?id=${m.id}" class="btn">View Market</a>
      `;

          if (isActive) activeContainer.appendChild(card);
          else inactiveContainer.appendChild(card);
        }

        // fallback if empty
        if (activeContainer.children.length === 0)
          activeContainer.innerHTML = "<p>No active markets at the moment.</p>";
        if (inactiveContainer.children.length === 0)
          inactiveContainer.innerHTML = "<p>No inactive markets in the last 30 days.</p>";
      } catch (err) {
        console.error(err);
        document.getElementById("active-markets").innerHTML = "<p>Error loading markets.</p>";
      }
    });
  </script>
  <footer style="
    margin-top:40px;
    padding:15px;
    text-align:center;
    font-size:0.85em;
    color:#555;
    background-color:#f9f9f9;
    border-top:1px solid #ddd;
  ">
    <p><strong>Disclaimer:</strong> This prediction market is a personal, educational, and experimental project.
      All trades and balances are <strong>virtual</strong> and have <strong>no monetary value</strong>.
      It is not intended for profit, investment, or gambling use.
    </p>
    <p>
      Developed for learning purposes using <strong>FastAPI</strong>, <strong>SQLAlchemy</strong>,
      and <strong>JavaScript</strong>. AI tools, including <strong>ChatGPT</strong>, were used for brainstorming,
      debugging, and documentation support during development.
    </p>
  </footer>
</body>

</html>
